{% extends 'base.html' %}

{% block title %}{% if edit_mode %}Editar{% else %}Criar{% endif %} Orçamento{% endblock %}

{% block page_title %}{% if edit_mode %}EDITAR{% else %}CRIAR{% endif %} ORÇAMENTO{% endblock %}

{% block content %}
{% if messages %}
<div class="messages">
    {% for message in messages %}
    <div class="alert alert-{% if message.tags %}{{ message.tags }}{% endif %}">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}

<form method="post" id="budget-form">
    {% csrf_token %}

    {% if form.errors %}
    <div class="alert alert-danger">
        <h4>Erros no formulário:</h4>
        {{ form.errors }}
    </div>
    {% endif %}

    {% if item_formset.errors %}
    <div class="alert alert-danger">
        <h4>Erros nos itens do orçamento:</h4>
        {{ item_formset.errors }}
    </div>
    {% endif %}

    <!-- Resto do conteúdo do formulário -->
    
    <div class="mb-3">
        <h4>Selecionar Cliente</h4>
        <div class="d-flex">
            <input type="text" id="customer_search" class="form-control me-2" placeholder="Pesquisar cliente por nome ou documento">
            <button type="button" id="search_customer_btn" class="btn btn-primary">Pesquisar Cliente</button>
        </div>
    </div>

    <div id="customer_results" class="mb-3" style="display: none;">
        <h5>Resultados da Pesquisa:</h5>
        <ul id="customer_list" class="list-group">
            <!-- Os resultados da pesquisa serão inseridos aqui via JavaScript -->
        </ul>
    </div>

    <div class="customer-info mb-3">
        <h5>Informações do Cliente</h5>
        <p><strong>Cliente:</strong> <span id="selected_customer_name">{% if form.instance.customer %}{{ form.instance.customer.name }}{% else %}Nenhum cliente selecionado{% endif %}</span></p>
        <p><strong>Telefone:</strong> <span id="selected_customer_phone">{% if form.instance.customer %}{{ form.instance.customer.phone }}{% endif %}</span></p>
        <p><strong>Documento:</strong> <span id="selected_customer_document">{% if form.instance.customer %}{{ form.instance.customer.document }}{% endif %}</span></p>
        {{ form.customer }}
    </div>

    <h4>Itens do Orçamento</h4>
    <div class="mb-3">
        <select id="material_select" class="form-control">
            <option value="">Selecione um material</option>
            {% for material in materials %}
                <option value="{{ material.id }}">{{ material.full_name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <input type="number" id="quantity_input" class="form-control" placeholder="Quantidade" min="0.01" step="0.01">
    </div>
    <button type="button" id="add_item_btn" class="btn btn-success mb-3">Adicionar Item</button>

    <table class="table" id="items_table">
        <thead>
            <tr>
                <th>Material</th>
                <th>Quantidade</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for form in item_formset %}
                <tr>
                    <td>
                        {{ form.material }}
                        {{ form.id }}
                    </td>
                    <td>{{ form.quantity }}</td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm remove-item">Remover</button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    {{ item_formset.management_form }}

    <div class="mt-3">
        <button type="submit" class="btn btn-primary">{% if edit_mode %}Atualizar{% else %}Salvar{% endif %} Orçamento</button>
        <a href="{% url 'budget_list' %}" class="btn btn-secondary">Cancelar</a>
    </div>
</form>
{% endblock %}

<!-- O bloco extra_js permanece o mesmo -->

{% block extra_js %}
<script>
    $(document).ready(function() {
        var itemFormsetPrefix = "{{ item_formset.prefix }}";
        var totalForms = $("#id_" + itemFormsetPrefix + "-TOTAL_FORMS");
        
        $("#add_item_btn").click(function() {
            var materialId = $("#material_select").val();
            var materialName = $("#material_select option:selected").text();
            var quantity = $("#quantity_input").val();
            
            if (materialId && quantity > 0) {
                addItemToTable(materialId, materialName, quantity);
                $("#material_select").val('');
                $("#quantity_input").val('');
            } else {
                alert("Por favor, selecione um material e insira uma quantidade válida.");
            }
        });
        
        function addItemToTable(materialId, materialName, quantity) {
            var newIndex = parseInt(totalForms.val());
            var template = `
                <tr>
                    <td>
                        <input type="hidden" name="${itemFormsetPrefix}-${newIndex}-material" value="${materialId}">
                        <input type="hidden" name="${itemFormsetPrefix}-${newIndex}-id" value="">
                        ${materialName}
                    </td>
                    <td>
                        <input type="number" name="${itemFormsetPrefix}-${newIndex}-quantity" value="${quantity}" step="0.01" min="0.01" class="form-control">
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm remove-item">Remover</button>
                    </td>
                </tr>
            `;
            $("#items_table tbody").append(template);
            totalForms.val(newIndex + 1);
        }
        
        $(document).on('click', '.remove-item', function() {
            $(this).closest('tr').remove();
            updateFormIndexes();
        });
        
        function updateFormIndexes() {
            $("#items_table tbody tr").each(function(index) {
                $(this).find('input').each(function() {
                    var name = $(this).attr('name').replace(/-\d+-/, `-${index}-`);
                    $(this).attr('name', name);
                });
            });
            totalForms.val($("#items_table tbody tr").length);
        }

        $("#search_customer_btn").click(function() {
            var searchTerm = $("#customer_search").val();
            if (searchTerm) {
                $.ajax({
                    url: '{% url "search_customers" %}',
                    data: {
                        'term': searchTerm
                    },
                    dataType: 'json',
                    success: function(data) {
                        var results = $("#customer_list");
                        results.empty();
                        if (data.length > 0) {
                            $.each(data, function(index, customer) {
                                results.append(`<li class="list-group-item customer-result" data-id="${customer.id}" data-name="${customer.name}" data-phone="${customer.phone}" data-document="${customer.document}">${customer.name} - ${customer.document}</li>`);
                            });
                            $("#customer_results").show();
                        } else {
                            results.append('<li class="list-group-item">Nenhum cliente encontrado</li>');
                            $("#customer_results").show();
                        }
                    }
                });
            }
        });
        
        $(document).on('click', '.customer-result', function() {
            var customerId = $(this).data('id');
            var customerName = $(this).data('name');
            var customerPhone = $(this).data('phone');
            var customerDocument = $(this).data('document');
            
            $("#id_customer").val(customerId);
            $("#selected_customer_name").text(customerName);
            $("#selected_customer_phone").text(customerPhone);
            $("#selected_customer_document").text(customerDocument);
            
            $("#customer_results").hide();
            $("#customer_search").val('');
        });
    });
</script>
{% endblock %}